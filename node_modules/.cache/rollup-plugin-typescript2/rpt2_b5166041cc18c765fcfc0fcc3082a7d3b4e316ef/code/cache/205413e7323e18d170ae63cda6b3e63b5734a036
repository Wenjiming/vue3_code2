{"code":"import { isArray, isIntegerKey } from \"@vue/shared\";\nexport function effect(fn, options = {}) {\n    const effect = createReactEffect(fn, options);\n    if (!options.lazy) {\n        effect();\n    }\n    return effect;\n}\nlet uid = 0;\nlet activeEffect; // 保存当前的effect\nlet effectstack = [];\nfunction createReactEffect(fn, options) {\n    const effect = function reactiveEffect() {\n        if (!effectstack.includes(effect)) { // 重复修改相同属性，状态合并\n            try {\n                effectstack.push(effect);\n                activeEffect = effect;\n                return fn(); // computed需要\n            }\n            finally {\n                effectstack.pop();\n                activeEffect = effectstack[effectstack.length - 1];\n            }\n        }\n    };\n    effect.uid = uid++; // 区别不同effect\n    effect._isEffect = true; // 区别effect是不是响应式的effect\n    effect.raw = fn; // 保存依赖回调\n    effect.options = options; // 保存传入属性\n    return effect;\n}\nlet targetMap = new WeakMap();\nexport function track(target, type, key) {\n    // key activeEffect 一一对应\n    /**\n     * WeakMap(\n     * {\n     *    target: Map({\n     *      key: Set({ effect1, effect2 })\n     *    })\n     * }\n     * )\n     */\n    // { name : '' }\n    // 1）定义未使用 2）非响应式数据(访问state.age)\n    if (activeEffect === undefined) {\n        return;\n    }\n    let depMap = targetMap.get(target);\n    if (!depMap) {\n        targetMap.set(target, (depMap = new Map));\n    }\n    let dep = depMap.get(key);\n    if (!dep) {\n        depMap.set(key, (dep = new Set));\n    }\n    if (!dep.has(activeEffect)) {\n        dep.add(activeEffect);\n    }\n    console.log(targetMap, 'targetMap');\n}\n/** effect可以树形结构，增加栈处理\n * 保存问题，activeEffect只保存了当前的\n * effect(()=>{ // effect1\n  //收集的 effect1\n    state .name\n    effect(()=> { //effect2\n      state.age//effect2\n    })\n    state.age // effect1\n  })\n *\n */\nexport function trigger(target, type, key, value, oldValue) {\n    let depsMap = targetMap.get(target);\n    if (!depsMap)\n        return; // 根据target找到对应依赖，找不到不更新\n    const effectSet = new Set();\n    const add = (effectAdd) => {\n        if (effectAdd) {\n            effectAdd.forEach(effect => effectSet.add(effect));\n        }\n    };\n    // 通过length属性，直接修改数组\n    if (key === 'length' && isArray(target)) {\n        const newLength = Number(value);\n        depsMap.forEach((dep, effectPro) => {\n            // state = { list: [1,2,3] }\n            // 依赖使用①：state.list.length effectPro = 'length'\n            // state.list.length = 1\n            // 依赖使用②：state.list[2] effectPro = 2, 数组变短执行effect,获取到最新（undefined）\n            // state.list.length = 1 dep: 不同effectPro的依赖Set({]})\n            // 如果更改长度小于依赖收集索引，需要重新执行effect\n            if (effectPro === 'length' || effectPro >= newLength) {\n                add(dep);\n            }\n        });\n    }\n    else { // 对象\n        if (key != undefined) {\n            add(depsMap.get(key));\n        }\n        switch (type) {\n            case \"add\" /* TriggerOpTypes.ADD */: // 新增\n                if (isIntegerKey(key) && isArray(target)) {\n                    add(depsMap.get('length'));\n                }\n                break;\n            case \"delete\" /* TriggerOpTypes.DELETE */:\n                // if (!isArray(target)) {\n                //   deps.push(depsMap.get(ITERATE_KEY))\n                //   if (isMap(target)) {\n                //     deps.push(depsMap.get(MAP_KEY_ITERATE_KEY))\n                //   }\n                // }\n                break;\n            // ADD DEL SET ??\n        }\n    }\n    effectSet.forEach((effect) => {\n        if (effect.options.sch) {\n            effect.options.sch(effect); // _dirty = true, computed, 不会主动触发effect执行\n        }\n        else {\n            effect();\n        }\n    });\n}\n//# sourceMappingURL=effect.js.map","references":["D:/own-demo/exercise/vue3-code/新建文件夹/vue3_code2/packages/shared/src/index.ts","D:/own-demo/exercise/vue3-code/新建文件夹/vue3_code2/packages/reactivity/src/operations.ts"],"map":"{\"version\":3,\"file\":\"effect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../packages/reactivity/src/effect.ts\"],\"names\":[],\"mappings\":\"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\"}"}
